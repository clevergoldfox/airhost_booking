<script src="{{ url_for('static', filename='js/app/visual.js')}}"></script>
<script type="text/javascript">

	$(document).ready(function () {

		pageSetUp();

		var me = {};
		if(localStorage.getItem("me")){
			const medata = JSON.parse(localStorage.getItem("me"));
			me = {
				"id": medata[0],
				"firstname": medata[1],
				"lastname": medata[2],
				"gender": medata[3],
				"birth": medata[4],
				"email": medata[5],
				"role": medata[6],
				"avatar": medata[8]
			};
		}
		console.log(me);

		if(me?.role == "admin" || me?.role == "manager"){
			$("#usermanage-nav").removeClass("d-none");
		} else {
			$("#usermanage-nav").addClass("d-none");
		}
		
		//================== start top bar ===============//
		
		if (me.avatar) {
			$("#top-avatar").attr("src", "{{ url_for('static', filename='img/avatars/default.png')}}".replace("default.png", me.avatar));
		} else {
			$("#top-avatar").attr("src", "{{ url_for('static', filename='img/avatars/default.png')}}");
		}
		$("#top-name").text(me.firstname && me.lastname ? me.firstname + " " + me.lastname + "さん" : "ユーザーさん");

		$("#profileedit").click(async function () {
			location.href = await "/profile";
		});
		$("#logout").click(function () {
			localStorage.removeItem("me");
			location.href = "/login";
		});
		//=============== end top bar ================//
		
		//=============== start visualization data  ==============//
		// operation days data adding 
        var operation_data = [];
		$("#fileaddbtn").click(function () {
			if($(this).attr("type")=="button"){
				$("#datafile").click();
			}
		});
		$("#datafile").change(function () {
			var fileName = $(this).val().split("\\").pop();
			console.log(fileName);
			$("#fileaddbtn").text("データフ追加(" + fileName + ")");
			$("#fileaddbtn").attr("type", "submit");
		});

		$("#datafile-form").submit(function (event) {
			event.preventDefault();
			var formData = new FormData($(this)[0]);
						
			$.ajax({
				type: "POST",
				url: "/operation",
				data: formData,
				contentType: false,
				processData: false,
				success: function (response) {
					if (response.status == "success") {
						$("#fileaddbtn").text("データフ追加(CSVァイル)");
						$("#datafile").val("");
						$("#fileaddbtn").attr("type", "button");
						localStorage.removeItem('operationData');
						localStorage.setItem('operationData', JSON.stringify(response.data));
						operation_data = JSON.parse(response.data);
                        draw_operation_chart(operation_data);
						
					} else {
						alert("Error: " + response.message);
					}
				},
				error: function (xhr, status, error) {
                    console.log(error);
                    
					alert("申し訳ありませんが、もう一度お試しください。");
				}
			});
		});
		
		
		// operation days data removing 
		$("#dataremove").click(function () {
			if (confirm("Are you sure you want to delete all data?")) {
				localStorage.removeItem('reservationData');
				reservation_data = [];
				activePage = 1;
				pageSize = 10;
				pageCount = 0;
				draw_reservationTable();
				draw_pagination();
			}
		});
		//=============== end reservation data  ==============//
	})

</script>

</body>

</html>